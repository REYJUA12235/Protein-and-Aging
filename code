# Association of dietary protein intake with accelerated biological aging and all-cause and cause-specific mortality
# Data Analysis: Juan Reyes Barrera, Omar Yaxmehen Bello-Chavolla and Neftali Eduardo Antonio Villa
# Latest version of Analysis 1 November of 2025
# Any question regarding analysis contact Juan Reyes Barrera at reyesbarrera_juan@hotmail.com

####---- Library----####

library(dplyr)
library(tidyverse)
library(readxl)
library(haven)
library(ggthemes)
library(ggpubr)
library(readr)
library(survival)
library(jtools)
library(gtsummary)
library(data.table)
library(epiR)
library(MASS)
library(glmnet)
library(pROC)
library(caret)
library(splines)
library(cliot)
library(rms)
library(ggsci)
library(OptimalCutpoints)
library(GGally)
library(moments)
library(nortest)
library(rmda)       
library(ggplot2)   
library(ggpubr)    
library(ggplotify)      
library(mice)
library(DataExplorer)
library(flextable)
library(officer)
library(caret)
library(e1071)
library(recipes)
library(broom)
library(caret) 
library(pROC) 

####Cargando bases de datos NHANES 1999-2000 Y 2001-2002###

ruta_carpeta <- "C:/Users/Usuario/Desktop/Analisis proteinas/analisis_proteinas_compartido"

# Obtener la lista de archivos .sav en la carpeta
archivos_sav <- list.files(path = ruta_carpeta, pattern = "\\.sav$", full.names = TRUE)

# Importar todas las bases y guardarlas en una lista con nombres según el archivo
lista_bases <- setNames(lapply(archivos_sav, read_sav), tools::file_path_sans_ext(basename(archivos_sav)))

# Renombrar las variables de cada base usando sus labels (si existen)
lista_bases <- lapply(lista_bases, function(df) {
  names(df) <- sapply(df, function(x) {
    if (!is.null(attr(x, "label"))) {
      attr(x, "label")  # Usa el label si existe
    } else {
      names(df)[which(df == x)]  # Mantiene el nombre original si no hay label
    }
  })
  df  # Retorna el data frame modificado
})

# (Opcional) Crear cada base como un objeto separado en el entorno global
for (i in seq_along(lista_bases)) {
  assign(names(lista_bases)[i], lista_bases[[i]])
}




## Reduccion de varibles en comun en cada set ###

## BMX ##
vars_comunes <- intersect(names(BMX), names(BMX_B))
BMX <- BMX[, vars_comunes, drop = FALSE]
BMX_B <- BMX_B[, vars_comunes, drop = FALSE]
BMX_total <- bind_rows(BMX, BMX_B)

## BPX ##
vars_comunes <- intersect(names(BPX), names(BPX_B))
BPX <- BPX[, vars_comunes, drop = FALSE]
BPX_B <- BPX_B[, vars_comunes, drop = FALSE]
BPX_total <- bind_rows(BPX, BPX_B)

## DEMO ##
vars_comunes <- intersect(names(DEMO), names(DEMO_B))
DEMO <- DEMO[, vars_comunes, drop = FALSE]
DEMO_B <- DEMO_B[, vars_comunes, drop = FALSE]
DEMO_total <- bind_rows(DEMO, DEMO_B)

## DRXTOT ##
vars_comunes <- intersect(names(DRXTOT), names(DRXTOT_B))
DRXTOT <- DRXTOT[, vars_comunes, drop = FALSE]
DRXTOT_B <- DRXTOT_B[, vars_comunes, drop = FALSE]
DRXTOT_total <- bind_rows(DRXTOT, DRXTOT_B)




## L11 ##
names(LAB11) <- trimws(names(LAB11))
names(L11_2_B) <- trimws(names(L11_2_B))
vars_comunes <- intersect(names(LAB11), names(L11_2_B))
LAB11 <- LAB11[, vars_comunes, drop = FALSE]
L11_2_B <- L11_2_B[, vars_comunes, drop = FALSE]
L11_total <- bind_rows(LAB11, L11_2_B)

## L13 ##
vars_comunes <- intersect(names(LAB13), names(L13_B))
LAB13 <- LAB13[, vars_comunes, drop = FALSE]
L13_B <- L13_B[, vars_comunes, drop = FALSE]
L13_total <- bind_rows(L13_B,LAB13)


## L25 ##
vars_comunes <- intersect(names(LAB25), names(L25_B))
LAB25 <- LAB25[, vars_comunes, drop = FALSE]
L25_B <- L25_B[, vars_comunes, drop = FALSE]
L25_total <- bind_rows(L25_B,LAB25)


## L40 ##
vars_comunes <- intersect(names(L40_2_B), names(LAB18))
LAB18 <- LAB18[, vars_comunes, drop = FALSE]
L40_2_B <- L40_2_B[, vars_comunes, drop = FALSE]
L40_total<- bind_rows(L40_2_B,LAB18)



## LAB 10##
names(LAB10) <- gsub(":", " ", names(LAB10))
vars_comunes <- intersect(names(LAB10), names(LAB10_B))
LAB10 <- LAB10[, vars_comunes, drop = FALSE]
LAB10_B <- LAB10_B[, vars_comunes, drop = FALSE]
LAB10_total<- bind_rows(LAB10,LAB10_B)


## TELO##
vars_comunes <- intersect(names(TELO_A), names(TELO_B))
TELO_A <- TELO_A[, vars_comunes, drop = FALSE]
TELO_B <- TELO_B[, vars_comunes, drop = FALSE]
TELO_total<- bind_rows(TELO_A,TELO_B)



## PAIQF##
vars_comunes <- intersect(names(PAQIAF), names(PAQIAF_B))
PAQIAF <- PAQIAF[, vars_comunes, drop = FALSE]
PAQIAF_B <- PAQIAF_B[, vars_comunes, drop = FALSE]
PAQIAF_total<- bind_rows(PAQIAF,PAQIAF_B)

## DIQ##
vars_comunes <- intersect(names(DIQ), names(DIQ_B))
DIQ <- DIQ[, vars_comunes, drop = FALSE]
DIQ_B <- DIQ_B[, vars_comunes, drop = FALSE]
DIQ_total<- bind_rows(DIQ,DIQ_B)

## SMQ##
vars_comunes <- intersect(names(SMQ), names(SMQ_B))
SMQ <- SMQ[, vars_comunes, drop = FALSE]
SMQ_B <- SMQ_B[, vars_comunes, drop = FALSE]
SMQ_total<- bind_rows(SMQ,SMQ_B)

## BPQ##
vars_comunes <- intersect(names(BPQ), names(BPQ_B))
BPQ <- BPQ[, vars_comunes, drop = FALSE]
BPQ_B <- BPQ_B[, vars_comunes, drop = FALSE]
BPQ_total<- bind_rows(BPQ,BPQ_B)



## Unir los data frames con full_join() usando el identificador común##

df_final <- BMX_total %>%
  full_join(BPX_total, by = "ID") %>%
  full_join(DEMO_total, by = "ID") %>%
  full_join(DRXTOT_total, by = "ID") %>%
  full_join(TELO_total, by = "ID") %>%
  full_join(L11_total, by = "ID") %>%
  full_join(L13_total, by = "ID") %>%
  full_join(L25_total, by = "ID") %>%
  full_join(LAB10_total, by = "ID") %>%
  full_join(PAQIAF_total, by = "ID") %>%
  full_join(DIQ_total, by = "ID") %>%
  full_join(SMQ_total, by = "ID") %>%
  full_join(BPQ_total, by = "ID") %>%
  full_join(L40_total, by = "ID") 


### Filtros ###


df_final <- df_final %>%
  filter(`Age at Screening Adjudicated - Recode` > 20)

df_final <- df_final %>%
  filter(!is.na(`Protein (gm)`))

df_final <- df_final %>%
  filter(!is.na(`Mean T/S ratio`))


## codificacion de variables para calcular anthropoage ##


table (df_final$`Race/Ethnicity - Recode`)
df_final$ID

# Recodificar la variable 'Race/Hispanic origin' según la nueva codificación
df_final$`Race/Ethnicity - Recode` <- factor(df_final$`Race/Ethnicity - Recode`,
                                             levels = c(1, 2, 3, 4, 5),
                                             labels = c("Mexican-American", "Other Hispanic", 
                                                        "Non-Hispanic White", "Non-Hispanic Black", 
                                                        "Other Race - Including Multi-Racial"))



df_final <- df_final %>%
  mutate(`Race/Ethnicity - Recode` = case_when(
    `Race/Ethnicity - Recode` %in% c("Other Hispanic", "Other Race - Including Multi-Racial") ~ "Other",
    TRUE ~ `Race/Ethnicity - Recode`
  ))

df_final <- df_final %>%
  mutate(Ethnicity = case_when(
    `Race/Ethnicity - Recode` == "Non-Hispanic White" ~ "White",
    `Race/Ethnicity - Recode` == "Non-Hispanic Black" ~ "Black",
    `Race/Ethnicity - Recode` == "Mexican-American" ~ "Mexican-American",
    TRUE ~ "Others"
  ))

df_final$Ethnicity <- recode(df_final$Ethnicity, "Others" = "Other")

df_final$Ethnicity <- factor(df_final$Ethnicity, levels = c("White", "Black", "Mexican-American", "Others"))

table(df_final$Ethnicity)

df_final <- df_final %>%
  mutate(Gender = recode(Gender, `1` = "Men", `2` = "Women"))
df_final$Gender <- factor(df_final$Gender, levels = c( "Women","Men"))

df_final <- df_final %>%
  mutate(`Standing Height (m)` = `Standing Height (cm)` / 100)

# Definir el requerimiento proteico de cada participante (0.8 g/kg)
df_final$protein_requirement <- df_final$`Weight (kg)` * 0.8

# Comparar si la proteína consumida cumple con el requerimiento
df_final$protein_status <- ifelse(df_final$`Protein (gm)` >= df_final$protein_requirement, 
                                  "Cumple con requerimiento", 
                                  "No cumple con requerimiento")

# Crear cuartiles de la variable 'Mean T/S ratio'
df_final$QTel <- cut(df_final$`Mean T/S ratio`, 
                     breaks = quantile(df_final$`Mean T/S ratio`, probs = seq(0, 1, 0.25), na.rm = TRUE), 
                     include.lowest = TRUE, 
                     labels = c("Q1", "Q2", "Q3", "Q4"))

hist(df_filter$QTel)
####calculo de anthropage###

df_final$AnthropoAge <- AnthropoAgeR::s_anthropoage(
  Age=df_final$`Age at Screening Adjudicated - Recode`,
  Sex=df_final$Gender,
  Weight=df_final$`Weight (kg)`,
  Waist=df_final$`Waist Circumference (cm)`,
  Height=df_final$`Standing Height (m)`,
  Ethnicity=df_final$Ethnicity
)




###calculo de phenoage ###

df_final$Phenoage<- phenoage(df_final$`Age at Screening Adjudicated - Recode`,df_final$`C-reactive protein(mg/dL)`,
                             df_final$`Lymphocyte percent (%)`, df_final$`White blood cell count (SI)`,
                             df_final$`Glucose (mg/dL)`, df_final$`Red cell distribution width (%)`,
                             df_final$`Albumin (g/dL)`,df_final$`Creatinine (mg/dL)`,
                             df_final$`Mean cell volume (fL)`, df_final$`Alkaline phosphotase (U/L)`)


df_final$P

##filtro de base para  solo datos completos de relojes biologicos ##
  
  colSums(is.na(df_final[, c("Age at Screening Adjudicated - Recode", "Gender","AnthropoAge","Mean T/S ratio")]))
  
  df_filter <- df_final[complete.cases(df_final[, c( "AnthropoAge","Mean T/S ratio")]), ]
  


### metrica de aceleracion ###

  
  library(AnthropoAgeR)
table(df_filter$`Race/Ethnicity - Recode`)
  
    df_filter$accel_antro <- age_accel(Age = df_filter$`Age at Screening Adjudicated - Recode`, 
                                     BA = df_filter$AnthropoAge,
                                     Sex = df_filter$Gender)
  
    
    df_filter$accel_antro
  df_filter$accel_phen <- age_accel(Age = df_filter$`Age at Screening Adjudicated - Recode`, 
                                    BA = df_filter$Phenoage,
                                    Sex = df_filter$Gender)
  
  #Crear la variable categórica "accel_category"#
  
  df_filter$accel_category_anthr <- ifelse(df_filter$accel_antro >= 0, "Aging Accelerated", "Aging Non-Accelerated")
  
  df_filter$accel_category_phe <- ifelse(df_filter$accel_phen >= 0, "Aging Accelerated", "Aging Non-Accelerated")

  
  ## CREACION DE CUARTILES DE PROTEINA  ##
  
 # Crear la columna 'Protein_quartile' con los valores correctos de los cuartiles
df_filter$Protein_quartile <- cut(df_filter$`Protein (gm)`,
                                  breaks = quantiles_protein,
                                  include.lowest = TRUE,
                                  labels = c("Q1", "Q2", "Q3", "Q4"))




### metricas de edad biologica ###

####calculo de anthropage###

df_final$AnthropoAge <- AnthropoAgeR::s_anthropoage(
  Age=df_final$`Age at Screening Adjudicated - Recode`,
  Sex=df_final$Gender,
  Weight=df_final$`Weight (kg)`,
  Waist=df_final$`Waist Circumference (cm)`,
  Height=df_final$`Standing Height (m)`,
  Ethnicity=df_final$Ethnicity
)

###calculo de phenoage ###

df_final$Phenoage<- phenoage(df_final$`Age at Screening Adjudicated - Recode`,df_final$`C-reactive protein(mg/dL)`,
                             df_final$`Lymphocyte percent (%)`, df_final$`White blood cell count (SI)`,
                             df_final$`Glucose (mg/dL)`, df_final$`Red cell distribution width (%)`,
                             df_final$`Albumin (g/dL)`,df_final$`Creatinine (mg/dL)`,
                             df_final$`Mean cell volume (fL)`, df_final$`Alkaline phosphotase (U/L)`)

#KDM using NHANES ##
kdm = kdm_nhanes(biomarkers=c("fev","sbp","totchol","hba1c","albumin","creat","lncrp","alp","bun"))


# calculo telomeros cortos #
p25 <- quantile(df_filtered$`Mean T/S ratio`, 0.25, na.rm = TRUE)

# Crear/redefinir Telomere_status
df_filtered$Telomere_status <- ifelse(df_filtered$`Mean T/S ratio` < p25, 
                                      "Low (<P25)", 
                                      "High (≥P25)")


### metrica de aceleracion categoricas ###

  AnthropoAge acceleration
df_final$Accel_AnthropoAge <- AnthropoAgeR::age_accel(
  Age = df_final$`Age at Screening Adjudicated - Recode`,
  BA  = df_final$AnthropoAge,
  Sex = df_final$Gender
)

# PhenoAge acceleration
df_final$Accel_PhenoAge <- BioAge::age_accel(
  chron_age = df_final$`Age at Screening Adjudicated - Recode`,
  bio_age   = df_final$PhenoAge
)

# KDM acceleration
df_final$Accel_KDM <- BioAge::age_accel(
  chron_age = df_final$`Age at Screening Adjudicated - Recode`,
  bio_age   = df_final$KDM



# Table 2 

# Función para obtener mediana (IQR)
summary_iqr <- function(data, variable){
  data %>%
    group_by(Protein_Quintiles) %>%
    summarise(
      Median = median({{ variable }}, na.rm = TRUE),
      Q1 = quantile({{ variable }}, 0.25, na.rm = TRUE),
      Q3 = quantile({{ variable }}, 0.75, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    mutate(Median_IQR = paste0(round(Median, 2), " (", round(Q1, 2), ", ", round(Q3, 2), ")"))
}

# Función para obtener conteos y porcentajes
summary_percent <- function(data, variable_cat){
  data %>%
    group_by(Protein_Quintiles, {{ variable_cat }}) %>%
    summarise(n = n(), .groups = "drop") %>%
    group_by(Protein_Quintiles) %>%
    mutate(percentage = round(100 * n / sum(n), 1)) %>%
    filter({{ variable_cat }} == 1) %>%  # Asume "1" = acelerado
    mutate(N_percent = paste0(n, " (", percentage, ")"))
}

# Telomere length
TL_summary <- summary_iqr(df_filtered, QTel)
print(TL_summary)
kruskal.test(QTel ~ Protein_Quintiles, data = df_filtered)

# AnthropoAge
Anthro_summary <- summary_iqr(df_filtered, anthropoage0)
print(Anthro_summary)
kruskal.test(anthropoage0 ~ Protein_Quintiles, data = df_filtered)

# PhenoAge
Pheno_summary <- summary_iqr(df_filtered, phenoage0)
print(Pheno_summary)
kruskal.test(phenoage0 ~ Protein_Quintiles, data = df_filtered)

# KDM
KDM_summary <- summary_iqr(df_filtered, kdm)
print(KDM_summary)
kruskal.test(kdm ~ Protein_Quintiles, data = df_filtered)

# Telomere acceleration
TL_accel <- summary_percent(df_filtered, accel_category_TL)
print(TL_accel)
chisq.test(table(df_filtered$Protein_Quintiles, df_filtered$accel_category_TL))

# AnthropoAge acceleration
Anthro_accel <- summary_percent(df_filtered, accel_category_anthr)
print(Anthro_accel)
chisq.test(table(df_filtered$Protein_Quintiles, df_filtered$accel_category_anthr))

# PhenoAge acceleration
Pheno_accel <- summary_percent(df_filtered, phenoage_category)
print(Pheno_accel)
chisq.test(table(df_filtered$Protein_Quintiles, df_filtered$phenoage_category))

# KDM acceleration
KDM_accel <- summary_percent(df_filtered, kdm_category)
print(KDM_accel)
chisq.test(table(df_filtered$Protein_Quintiles, df_filtered$kdm_category))

# TABLE 3: Linear regression models


# Lista de desenlaces continuos
outcomes_cont <- c("QTel", "AnthropoAge", "PhenoAge", "kdm")

# Función para ajustar modelos lineales
fit_lm_models <- function(data, outcome) {
  # No ajustado
  model_unadj <- lm(as.formula(paste(outcome, "~ Protein_Quintiles + Protein_gkg_day")), data = data)
  # Ajustado
  model_adj <- lm(as.formula(paste(outcome, "~ Protein_Quintiles + Protein_gkg_day + age + sex + energy_kcal + ethnicity + poverty_ratio + smoking_status + physical_activity + hypertension + diabetes")), 
                  data = data)
  
  # Extraer resultados
  tidy_unadj <- broom::tidy(model_unadj, conf.int = TRUE) %>%
    filter(term != "(Intercept)") %>%
    mutate(Model = "Unadjusted", Outcome = outcome)
  
  tidy_adj <- broom::tidy(model_adj, conf.int = TRUE) %>%
    filter(term != "(Intercept)") %>%
    mutate(Model = "Adjusted", Outcome = outcome)
  
  bind_rows(tidy_unadj, tidy_adj)
}

# Ejecutar modelos para todos los desenlaces
results_linear <- map_df(outcomes_cont, ~fit_lm_models(df_filtered, .x))

# Limpiar etiquetas
results_linear <- results_linear %>%
  mutate(term = recode(term,
                       "Protein_gkg_day" = "Continuous (g/kg/day)",
                       "Protein_QuintilesQ2" = "Q2 (0.59–0.81)",
                       "Protein_QuintilesQ3" = "Q3 (0.82–1.04)",
                       "Protein_QuintilesQ4" = "Q4 (1.05–1.37)",
                       "Protein_QuintilesQ5" = "Q5 (>1.37)")) %>%
  select(Outcome, term, Model, estimate, conf.low, conf.high, p.value)



# FIGURE 2: Forest plot – Odds Ratios for Accelerated Aging

results_logistic <- results_logistic %>%
  mutate(Outcome = recode(Outcome,
                          "TL_AgeAccel" = "Telomere Age Accel",
                          "AnthropoAgeAccel" = "AnthropoAge Accel",
                          "PhenoAgeAccel" = "PhenoAge Accel",
                          "KDMAgeAccel" = "KDM Biological Age Accel"))

# Mantener solo modelo ajustado
results_plot <- results_logistic %>%
  filter(Model == "Adjusted") %>%
  mutate(term = recode(term,
                       "Protein_gkg_day" = "Continuous (g/kg/day)",
                       "Protein_QuintilesQ2" = "Q2 (0.59–0.81)",
                       "Protein_QuintilesQ3" = "Q3 (0.82–1.04)",
                       "Protein_QuintilesQ4" = "Q4 (1.05–1.37)",
                       "Protein_QuintilesQ5" = "Q5 (>1.37)")) %>%
  mutate(term = fct_rev(factor(term, levels = unique(term)))) # invertir orden visual

# Crear forest plot con facet por desenlace
ggplot(results_plot, aes(x = term, y = OR, ymin = conf.low, ymax = conf.high)) +
  geom_pointrange(size = 0.5, color = "black") +
  geom_hline(yintercept = 1, linetype = "dashed", color = "gray40") +
  coord_flip() +
  facet_wrap(~Outcome, ncol = 2, scales = "free_y") +
  scale_y_log10(limits = c(0.2, 5), breaks = c(0.25, 0.5, 1, 2, 4)) +
  labs(
    x = "",
    y = "Odds Ratio (log scale)",
    title = "Figure 2. Association of dietary protein with accelerated biological aging",
    subtitle = "Adjusted models for age, sex, energy intake, ethnicity, poverty ratio,\nsmoking, physical activity, hypertension, and diabetes"
  ) +
  theme_bw(base_size = 11) +
  theme(
    strip.background = element_rect(fill = "gray90", color = NA),
    strip.text = element_text(face = "bold"),
    axis.text.y = element_text(size = 9),
    axis.text.x = element_text(size = 8),
    plot.title = element_text(face = "bold", size = 12),
    plot.subtitle = element_text(size = 9)
  )



# TABLE 4 – Association between protein intake, biological markers, and all-cause mortality

surv_obj <- Surv(df_filter3$permth_int, df_filter3$mortstat)

# MODELOS PRINCIPALES (univariados y ajustados)

## --- Modelo 1: Protein intake ---
m1_unadj <- coxph(surv_obj ~ protein_per_kg_per_day, data = df_filter3)
m1_adj   <- coxph(surv_obj ~ protein_per_kg_per_day + Gender + residuos + Energy_kcal +
                    Race + Family_PIR + Diabetes_h + Activity + Hypertension + Smoking,
                  data = df_filter3)

## --- Modelo 2: Telomere length ---
m2_unadj <- coxph(surv_obj ~ `Mean T/S ratio`, data = df_filter3)
m2_adj   <- coxph(surv_obj ~ `Mean T/S ratio` + Gender + residuos + Energy_kcal +
                    Race + Family_PIR + Diabetes_h + Activity + Hypertension + Smoking,
                  data = df_filter3)

## --- Modelo 3: Protein + Telomere length ---
m3_unadj <- coxph(surv_obj ~ protein_per_kg_per_day + `Mean T/S ratio`, data = df_filter3)
m3_adj   <- coxph(surv_obj ~ protein_per_kg_per_day + `Mean T/S ratio` + Gender + residuos +
                    Energy_kcal + Race + Family_PIR + Diabetes_h + Activity +
                    Hypertension + Smoking, data = df_filter3)

## --- Modelo 4: AnthropoAge ---
m4_unadj <- coxph(surv_obj ~ AnthropoAge, data = df_filter3)
m4_adj   <- coxph(surv_obj ~ AnthropoAge + Gender + residuos + Energy_kcal + Race +
                    Family_PIR + Diabetes_h + Activity + Hypertension + Smoking,
                  data = df_filter3)

## --- Modelo 5: Protein + AnthropoAge ---
m5_unadj <- coxph(surv_obj ~ protein_per_kg_per_day + AnthropoAge, data = df_filter3)
m5_adj   <- coxph(surv_obj ~ protein_per_kg_per_day + AnthropoAge + Gender + residuos +
                    Energy_kcal + Race + Family_PIR + Diabetes_h + Activity +
                    Hypertension + Smoking, data = df_filter3)

## --- Modelo 6: PhenoAge ---
m6_unadj <- coxph(surv_obj ~ phenoage0, data = df_filter3)
m6_adj   <- coxph(surv_obj ~ phenoage0 + Gender + residuos + Energy_kcal + Race +
                    Family_PIR + Diabetes_h + Activity + Hypertension + Smoking,
                  data = df_filter3)

## --- Modelo 7: Protein + PhenoAge ---
m7_unadj <- coxph(surv_obj ~ protein_per_kg_per_day + phenoage0, data = df_filter3)
m7_adj   <- coxph(surv_obj ~ protein_per_kg_per_day + phenoage0 + Gender + residuos +
                    Energy_kcal + Race + Family_PIR + Diabetes_h + Activity +
                    Hypertension + Smoking, data = df_filter3)

## --- Modelo 8: KDM ---
m8_unadj <- coxph(surv_obj ~ kdm, data = df_filter3)
m8_adj   <- coxph(surv_obj ~ kdm + Gender + residuos + Energy_kcal + Race +
                    Family_PIR + Diabetes_h + Activity + Hypertension + Smoking,
                  data = df_filter3)

## --- Modelo 9: Protein + KDM ---
m9_unadj <- coxph(surv_obj ~ protein_per_kg_per_day + kdm, data = df_filter3)
m9_adj   <- coxph(surv_obj ~ protein_per_kg_per_day + kdm + Gender + residuos +
                    Energy_kcal + Race + Family_PIR + Diabetes_h + Activity +
                    Hypertension + Smoking, data = df_filter3)

get_hr <- function(model, model_name, type) {
  tidy(model, exponentiate = TRUE, conf.int = TRUE) %>%
    select(term, estimate, conf.low, conf.high, p.value) %>%
    mutate(Model = model_name, Type = type)
}

results_all <- bind_rows(
  get_hr(m1_unadj, "Protein intake", "Unadjusted"),
  get_hr(m1_adj,   "Protein intake", "Adjusted"),
  get_hr(m2_unadj, "Telomere length", "Unadjusted"),
  get_hr(m2_adj,   "Telomere length", "Adjusted"),
  get_hr(m3_unadj, "Protein + Telomere length", "Unadjusted"),
  get_hr(m3_adj,   "Protein + Telomere length", "Adjusted"),
  get_hr(m4_unadj, "AnthropoAge", "Unadjusted"),
  get_hr(m4_adj,   "AnthropoAge", "Adjusted"),
  get_hr(m5_unadj, "Protein + AnthropoAge", "Unadjusted"),
  get_hr(m5_adj,   "Protein + AnthropoAge", "Adjusted"),
  get_hr(m6_unadj, "PhenoAge", "Unadjusted"),
  get_hr(m6_adj,   "PhenoAge", "Adjusted"),
  get_hr(m7_unadj, "Protein + PhenoAge", "Unadjusted"),
  get_hr(m7_adj,   "Protein + PhenoAge", "Adjusted"),
  get_hr(m8_unadj, "KDM", "Unadjusted"),
  get_hr(m8_adj,   "KDM", "Adjusted"),
  get_hr(m9_unadj, "Protein + KDM", "Unadjusted"),
  get_hr(m9_adj,   "Protein + KDM", "Adjusted")
)

results_all <- results_all %>%
  mutate(
    HR_CI = sprintf("%.2f (%.2f – %.2f)", estimate, conf.low, conf.high),
    Sig = ifelse(p.value < 0.0001, "*", "")
  ) %>%
  select(Model, Type, term, HR_CI, Sig)

# Librerías necesarias
library(survival)
library(dplyr)

# Asumimos que ya tienes df_filter3 con variables limpias
# y que 'mediation_ci1' es tu función personalizada

# Re-codificaciones básicas
df_filter3 <- df_filter3 %>%
  rename(
    Energy_kcal = `Energy (kcal)`,
    Family_PIR = `Family PIR`,
    Race = `Race/Ethnicity - Recode`,
    Diabetes_h = `Doctor told you have diabetes`,
    Activity = `Activity level`,
    Hypertension = `Ever told you had high blood pressure`,
    Smoking = `Do you now smoke cigarettes`
  )

# Crear variable binaria de actividad
df_filter3 <- df_filter3 %>%
  mutate(Activity_binary = ifelse(Activity == "Moderate", 1,
                                  ifelse(Activity == "Low", 0, NA)))

# FUNCIÓN PARA UN MEDIADOR

run_mediation <- function(mediator_var, data, method = "Cox") {

  # Modelo 1: mediador ~ exposición + covariables
  glm1 <- glm(scale(data[[mediator_var]]) ~ scale(protein_per_kg_per_day) +
                Gender + residuos + Energy_kcal + Race + 
                Diabetes_h + Activity_binary + Hypertension + Smoking + Family_PIR,
              data = data)

  # Modelo 2: mortalidad ~ exposición + mediador + covariables
  m2 <- coxph(Surv(permth_int, mortstat) ~ scale(data[[mediator_var]]) + 
                scale(protein_per_kg_per_day) + Gender + residuos + Energy_kcal +
                Race + Diabetes_h + Activity_binary + Hypertension + Smoking + Family_PIR,
              data = data)

  # Extraer coeficientes y varianzas
  if (method == "Cox") {
    lambdas <- m2$coefficients
    lambdas.var <- m2$var
  } else if (method == "Aalen") {
    lambdas <- aalen2$gamma
    lambdas.var <- aalen2$robvar.gamma
  }

  # Calcular efectos de mediación con tu función
  results <- mediation_ci1(
    a = lambdas[2],         # efecto directo (exposición)
    b = lambdas[1],         # efecto mediador
    var_a = lambdas.var[2,2],
    cov_ab = lambdas.var[2,1],
    var_b = lambdas.var[1,1],
    beta_m = glm1$coef[2],  # efecto exposición→mediador
    var_beta_m = vcov(glm1)[2,2],
    G = 10^6,
    method = method
  )

  return(results)
}

mediators <- c("Mean T/S ratio", "AnthropoAge", "phenoage0", "kdm")

mediation_results <- lapply(mediators, function(med) {
  res <- run_mediation(med, df_filter3, method = "Cox")
  data.frame(Mediator = med, res)
})

# Combinar en un solo data frame
mediation_results_df <- do.call(rbind, mediation_results)

print(mediation_results_df)


### Analisis suplementario ###

Figura suplementaria 2

###  Correlación entre métricas de edad biológica y edad cronológica  ##
df_corr <- df_final[, c(
  "Age at Screening Adjudicated - Recode",
  "Mean T/S ratio",
  "AnthropoAge",
  "PhenoAge",
  "KDM"
)]

df_corr <- df_corr %>%
  rename(
    ChronAge = `Age at Screening Adjudicated - Recode`,
    Telomere = `Mean T/S ratio`
  )
ggpairs(df_corr,
        lower = list(continuous = wrap("points", color = "black")),
        upper = list(continuous = wrap("cor", size = 5)),
        diag = list(continuous = wrap("barDiag", fill = "gray"))) +
  theme_minimal() +
  labs(title = "Correlación entre edad cronológica y métricas de edad biológica")

metrics <- c("Telomere", "AnthropoAge", "PhenoAge", "KDM")

cor_results <- data.frame(Variable = metrics, r = NA, p_value = NA)

for (i in seq_along(metrics)) {
  cor_test <- cor.test(df_corr[[metrics[i]]], df_corr$ChronAge, method = "spearman")
  cor_results$r[i] <- cor_test$estimate
  cor_results$p_value[i] <- cor_test$p.value
}

cor_results <- cor_results %>%
  mutate(
    r = round(r, 3),
    p_value = format.pval(p_value, digits = 3, scientific = TRUE)
  )


FIGURA SUPLEMENTARIA 3


df <- df_filter3                     # tu data.frame
mediators <- c("Mean T/S ratio", "AnthropoAge", "phenoage0", "kdm")
outcomes  <- c("Heart_diseases", "Cerebrovascular_diseases", "Malignant_neoplasms")
exposure  <- "protein_g_per_day"
covariates <- c("Gender","residuos","Energy_kcal","Race","Family_PIR","Diabetes_h","Activity","Hypertension","Smoking")
method <- "Cox"   # o "Aalen"
Gsim <- 1e6       # argumento para mediation_ci1 (si tu función lo usa)


make_formula <- function(lhs, rhs_vars){
  rhs <- paste(rhs_vars, collapse = " + ")
  as.formula(paste0(lhs, " ~ ", rhs))
}

results <- data.frame(
  mediator = character(),
  outcome = character(),
  ACME = numeric(), ACME_lci = numeric(), ACME_uci = numeric(),
  ADE  = numeric(), ADE_lci = numeric(), ADE_uci = numeric(),
  prop_med = numeric(), prop_med_lci = numeric(), prop_med_uci = numeric(),
  stringsAsFactors = FALSE
)

for (m in mediators){
  # mediador como variable (si tiene espacios, usar backticks en fórmulas)
  med_var <- m
  for (y in outcomes){
    out_var <- y

    # 1) Modelo lineal para el mediador (mediador ~ exposure + covs)
    #   Escalamos exposure y mediador tal como en tus ejemplos
    lhs_glm <- paste0("scale(`", med_var, "`)")
    rhs_glm <- c(paste0("scale(", exposure, ")"), covariates)
    f_glm <- make_formula(lhs_glm, rhs_glm)
    glm1 <- try(glm(f_glm, data = df), silent = TRUE)
    if (inherits(glm1, "try-error")){
      warning("Error en glm para mediador: ", med_var)
      next
    }

    # 2) Modelo de supervivencia para el outcome (Cox)
    #    Usamos Surv(permth_int, outcome)
    #    Nota: si outcome no es binaria o no está codificada, conviene checar antes
    surv_lhs <- paste0("Surv(permth_int, ", out_var, ")")
    rhs_cox <- c(paste0("scale(`", med_var, "`)"), paste0("scale(", exposure, ")"), covariates)
    f_cox <- make_formula(surv_lhs, rhs_cox)
    m2 <- try(coxph(f_cox, data = df), silent = TRUE)
    if (inherits(m2, "try-error")){
      warning("Error en coxph para outcome: ", out_var)
      next
    }

    # 3) Extraer lambdas según método (adaptar si usas Aalen)
    if (method == "Aalen"){
      # asumo que la salida de aalen fue calculada antes y se llama aalen2. 
      # Si no, aquí habría que ejecutar la función que corresponda.
      if (!exists("aalen2")) stop("Si usas method='Aalen' debes tener 'aalen2' calculado.")
      lambdas <- aalen2$gamma
      lambdas.var <- aalen2$robvar.gamma
    } else if (method == "Cox"){
      lambdas <- m2$coefficients
      lambdas.var <- m2$var
    } else {
      stop("method no reconocido. Usa 'Cox' o 'Aalen'.")
    }

    # Asumo que la posición de interest es:
    #  lambdas[2] = coef de exposure; lambdas[1] = coef del mediador
    #  Si tu coxph devuelve otro orden, ajústalo.
    #  Aquí guardo el retorno de mediation_ci1; adaptar según su salida real.
    med_out <- try(mediation_ci1(
      lambdas[2], lambdas[1],
      lambdas.var[2,2], lambdas.var[2,1], lambdas.var[1,1],
      glm1$coef[2], vcov(glm1)[2,2],
      G = Gsim, method = method
    ), silent = TRUE)

    if (inherits(med_out, "try-error")){
      warning("Error en mediation_ci1 para ", med_var, " -> ", out_var)
      next
    }

    if (!all(c("ACME","ACME_lci","ACME_uci","ADE","prop_med") %in% names(med_out))){
      # intenta inferir o alertar
      warning("La salida de mediation_ci1 no tiene los nombres esperados. Revisa su estructura.")
      print(str(med_out))
      # Intento defensivo: asignar NA y guardar lo que exista
      ACME <- ifelse("ACME" %in% names(med_out), med_out$ACME, NA)
      ACME_lci <- ifelse("ACME_lci" %in% names(med_out), med_out$ACME_lci, NA)
      ACME_uci <- ifelse("ACME_uci" %in% names(med_out), med_out$ACME_uci, NA)
      ADE <- ifelse("ADE" %in% names(med_out), med_out$ADE, NA)
      prop_med <- ifelse("prop_med" %in% names(med_out), med_out$prop_med, NA)
      prop_med_lci <- ifelse("prop_med_lci" %in% names(med_out), med_out$prop_med_lci, NA)
      prop_med_uci <- ifelse("prop_med_uci" %in% names(med_out), med_out$prop_med_uci, NA)
    } else {
      ACME <- med_out$ACME
      ACME_lci <- med_out$ACME_lci
      ACME_uci <- med_out$ACME_uci
      ADE <- med_out$ADE
      # si tu función retorna ADE_lci/uci y prop_med con CI, ajústalos
      ADE_lci <- ifelse("ADE_lci" %in% names(med_out), med_out$ADE_lci, NA)
      ADE_uci <- ifelse("ADE_uci" %in% names(med_out), med_out$ADE_uci, NA)
      prop_med <- med_out$prop_med
      prop_med_lci <- ifelse("prop_med_lci" %in% names(med_out), med_out$prop_med_lci, NA)
      prop_med_uci <- ifelse("prop_med_uci" %in% names(med_out), med_out$prop_med_uci, NA)
    }


#Tabla suplementaria 5

# Librerías necesarias
library(dplyr)
library(gtsummary)

# Crear nuevas variables energéticas y proporcionales
df_filtered <- df_filtered %>%
  mutate(
    Energy_from_Protein = `Protein (gm)` * 4,
    Energy_from_Carbohydrates = `Carbohydrate (gm)` * 4,
    Energy_from_Fat = `Total fat (gm)` * 9,
    
    Pct_Protein_from_Total = (Energy_from_Protein / `Energy (kcal)`) * 100,
    Pct_Carb_from_Total = (Energy_from_Carbohydrates / `Energy (kcal)`) * 100,
    Pct_Fat_from_Total = (Energy_from_Fat / `Energy (kcal)`) * 100
  )

# Variables de interés
variables <- c(
  "Energy (kcal)",
  "Energy_from_Carbohydrates", "Pct_Carb_from_Total", "Carbohydrate (gm)",
  "Energy_from_Fat", "Pct_Fat_from_Total", "Total fat (gm)",
  "Energy_from_Protein", "Pct_Protein_from_Total", "Protein (gm)",
  "protein_per_kg_per_day", "protein_per_kg_IBW_per_day", "protein_status"
)

# Crear tabla resumen general (sin agrupar)
tabla_dieta <- df_filtered %>%
  select(all_of(variables)) %>%
  tbl_summary(
    statistic = list(
      all_continuous() ~ "{median} ({p25}–{p75})",
      all_categorical() ~ "{n} ({p}%)"
    ),
    digits = all_continuous() ~ 2,
    label = list(
      `Energy (kcal)` ~ "Total energy intake (kcal/day)",
      Energy_from_Carbohydrates ~ "Energy from carbohydrates (kcal/day)",
      Pct_Carb_from_Total ~ "Carbohydrates (% of total kcal)",
      `Carbohydrate (gm)` ~ "Carbohydrate intake (g/day)",
      Energy_from_Fat ~ "Energy from fat (kcal/day)",
      Pct_Fat_from_Total ~ "Fat (% of total kcal)",
      `Total fat (gm)` ~ "Total fat intake (g/day)",
      Energy_from_Protein ~ "Energy from protein (kcal/day)",
      Pct_Protein_from_Total ~ "Protein (% of total kcal)",
      `Protein (gm)` ~ "Protein intake (g/day)",
      protein_per_kg_per_day ~ "Protein per kg of body weight (g/kg/day)",
      protein_per_kg_IBW_per_day ~ "Protein per kg of ideal body weight (g/kg IBW/day)",
      protein_status ~ "Protein adequacy"
    ),
    missing = "no"
  ) %>%
  bold_labels()










